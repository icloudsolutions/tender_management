<?xml version="1.0" encoding="utf-8"?>
<odoo>
	<!-- Inheriting Purchase Portal List View -->
    <template id="sh_tender_rfq_portal_template" inherit_id="purchase.portal_my_purchase_rfqs" name="Portal: Tender My RFQ's">
        <xpath expr="//thead//tr[hasclass('active')]//th[1]" position="after">
            <th>Tender</th>
        </xpath>
        <xpath expr="//t[@t-foreach='rfqs']//tr[1]//td[1]" position="after">
            <td>
                <a t-attf-href="/my/tender/#{rfq.agreement_id.id}?#{keep_query()}"><t t-esc="rfq.agreement_id.name" /></a>
            </td>
        </xpath>
    </template>
    <!-- Inheriting Purchase Portal Form view content -->
    <template id="sh_tender_rfq_portal_content_template" inherit_id="purchase.purchase_order_portal_content" name="Tender RFQ Portal Content">
        <xpath expr="//div[@id='introduction']" position="after">
            <t t-if="order.agreement_id.state=='closed'">
                <div id="update_message">
                    <div class="alert alert-danger">
                        <h4><strong>Bid Already Closed.</strong></h4>
                    </div>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@id='informations']//div[hasclass('mb-3','col-6')]" position="after">
            <div class="mb-3 col-6">
                <strong>Tender:</strong><a t-attf-href="/my/tender/#{order.agreement_id.id}?#{keep_query()}"><t t-esc="order.agreement_id.name" /></a>
            </div>
        </xpath>
        <xpath expr="//div[@id='currency_div']" position="replace">
            <div class="col-3" style="mergin: 0; padding: 0;" id="currency_div">
                <t t-if="order.agreement_id and order.agreement_id.state in ['closed','cancel']">
                    <span t-field="order.currency_id"/>
                </t>
                <t t-else="">
                    <t t-if="order.sh_bid_updated or order.state in ['purchase','done','cancel']">
                        <span t-field="order.currency_id"/>
                    </t>
                    <t t-else="">
                        <select class="form-control currency" id="currency_id" name="currency_id">
                            <option value="currency" selected="True">--Select Currency--</option>
                            <t t-foreach="request.env['res.currency'].sudo().search([('active','=',True)])" t-as="c">
                                <t t-if="request.env.user.partner_id.property_purchase_currency_id and c.id == request.env.user.partner_id.property_purchase_currency_id.id">
                                    <option t-att-value="c.id" t-att-selected="True"><t t-esc="c.name" /></option>
                                </t>
                                <t t-else="">
                                    <t t-if="order.currency_id and order.currency_id.id == c.id">
                                        <option t-att-value="c.id" t-att-selected="True"><t t-esc="c.name" /></option>
                                    </t>
                                    <t t-else="">
                                        <option t-att-value="c.id"><t t-esc="c.name" /></option>
                                    </t>
                                </t>
                            </t>
                        </select>
                    </t>
                </t>
            </div>
        </xpath>
        <xpath expr="//div[@id='update_product_qty']" position="replace">
            <t t-if="order.agreement_id and order.agreement_id.state in ['closed','cancel']">
                <div class="col-lg-2" id="update_product_qty">
                    <span t-field="ol.price_unit"/>
                </div>
            </t>
            <t t-else="">
                <div class="col-lg-2" id="update_product_qty">
                    <t t-if="order.sh_bid_updated or order.state in ['purchase','done','cancel']">
                        <span t-field="ol.price_unit"/>
                    </t>
                    <t t-else="">
                        <input type="text" pattern="[0-9]+([\.,][0-9]+)?" class="form-control quantity" id="unit_price" t-att-name="ol.id" t-att-value="str(ol.price_unit)"/>
                    </t>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@id='update_note']" position="replace">
            <div class="col-lg-2" id="update_note">
                <t t-if="order.agreement_id and order.agreement_id.state in ['closed','cancel']">
                    <span t-field="ol.sh_tender_note"/>
                </t>
                <t t-else="">
                    <t t-if="order.sh_bid_updated or order.state in ['purchase','done','cancel']">
                        <span t-field="ol.sh_tender_note"/>
                    </t>
                    <t t-else="">
                        <t t-set="tender_note" t-value=""/>
                        <t t-if="ol.sh_tender_note">
                            <t t-set="tender_note" t-value="str(ol.sh_tender_note)"/>		
                        </t>
                        <input type="text" class="form-control note" id="note" t-attf-name="#{ol.id}_note" t-att-value="tender_note" />
                    </t>
                </t>
            </div>
        </xpath>
        <xpath expr="//div[@id='supplier_note']" position="replace">
            <div class="col-12" id="supplier_note">
                <label for="rfq_note" style="margin-top: 10px;">Supplier Note/Comment</label>
                <t t-if="order.agreement_id and order.agreement_id.state in ['closed','cancel']">
                    <span t-field="order.sh_supplier_note"/>
                </t>
                <t t-else="">
                    <t t-if="order.sh_bid_updated or order.state in ['purchase','done','cancel']">
                        <span t-field="order.sh_supplier_note"/>
                    </t>
                    <t t-else="">
                        <input type="text" name="rfq_note" class="form-control" id="rfq_note" style="width:100%;margin-bottom:20px;" placeholder="Supplier Note/Comment......" t-att-value="order.sh_supplier_note"/>
                    </t>
                </t>
            </div>
        </xpath>
        <xpath expr="//section[3]" position="after">
            <h3 id="sh_document">Documents</h3>
                <div class="row">
                    <t t-foreach="request.env['ir.attachment'].sudo().search([('res_model','=','purchase.order'),('res_id','=',order.id),('sh_is_publish_in_portal','=',True)])" t-as="user_document">
                        <div class="col-4 my-2">
                            <div style='display: flex;align-items: center;background: #3aadaa;border-radius: 3px;justify-content: space-between;overflow: hidden;'>
                                <div style='display: flex;align-items:center;width:89%;'>
                                        <t t-set="img_src" t-value="'/web/image/' + str(user_document.id)"/>
                                        <div style='display:block;'>
                                                <t t-set="webimage" t-value="user_document.mimetype"/>
                                                <div t-if="user_document.type == 'url'" class="o_url_image fa fa-link fa-3x text-muted" aria-label="Image is a link"/>
                                                <img t-elif="webimage=='image/jpeg' or webimage=='image/jpg' or webimage=='image/gif' or webimage=='image/png'" t-att-src="img_src" alt="Document" class="o_attachment_image" style='height:30px;width:30px;display:block;'/>
                                                <div t-else="webimage!='image/jpeg' or webimage!='image/jpg' or webimage!='image/gif' or webimage!='image/png'" class="o_image o_image_thumbnail" t-att-data-mimetype="user_document.mimetype" style='height:30px;width:30px;display:block;'/>
                                        </div>
                                    <div style='overflow: hidden;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 1;-webkit-box-orient: vertical;color: #fff;width: 89%;    margin-left: 6px;'>
                                        <span t-esc="user_document.name" t-att-title='user_document.name'/>
                                    </div>
                                </div>
                                
                                <div>
                                    <input type="hidden" id="attachment_id" name="attachment_id" t-att-value="user_document.id" />
                                    <a t-att-href="'/po/attachment/download?attachment_id=%i' % user_document.id" style='color: #fff;height: 100%;padding: 7px 9px;'>
                                        <span class="fa fa-download" />
                                    </a>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
        </xpath>
    </template>
    <!-- Inheriting Rfq Portal Update Bid form view -->
    <template id="sh_tender_portal_rfq_portal_update_content" inherit_id="sh_all_in_one_tender_bundle.rfq_portal_update_content" name="Tender Update RFQ Portal Content">
        <xpath expr="//div[@id='update_message']" position="after">
            <t t-if="quotes.agreement_id.state=='closed'">
                <div id="error_message">
                    <div class="alert alert-danger">
                        <h4><strong>Bid Already Closed.</strong></h4>
                    </div>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@id='informations']//div[hasclass('mb-3','col-6')]" position="after">
            <div class="mb-3 col-6">
                <strong>Tender:</strong><a t-attf-href="/my/tender/#{quotes.agreement_id.id}?#{keep_query()}"><t t-esc="quotes.agreement_id.name" /></a>
            </div>
        </xpath>
    </template>
    <!-- Inheriting Purchase Order portal form view -->
    <template id="purchase_order_template_custom" inherit_id="purchase.portal_my_purchase_orders">
        <xpath expr="//thead//th[1]" position="after">
            <th>Tender</th>
        </xpath>
        <xpath expr="//t[@t-call='portal.portal_table']//t[@t-foreach='orders']//td[1]" position="after">
            <td>
                <a t-attf-href="/my/tender/#{order.agreement_id.id}?#{keep_query()}"><t t-esc="order.agreement_id.name" /></a>
            </td>
        </xpath>
    </template>
</odoo>
