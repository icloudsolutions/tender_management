name: Deploy Veluna Addons

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: /root/nextgen/veluna19
  ADDONS_DIR: addons

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          # Uses the private key we generated earlier
          printf '%s\n' "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Add your server to known hosts to prevent hanging
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy addons (rsync)
        run: |
          # Define the SSH command for rsync
          RSYNC_RSH="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new"
          
          # Sync everything from the GitHub root to the server addons folder
          # We EXCLUDE the config/db folders so we don't overwrite server data
          rsync -avz --delete -e "$RSYNC_RSH" \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'postgresql/' \
            --exclude 'etc/' \
            --exclude 'docker-compose.yml' \
            --exclude 'README.md' \
            ./ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/${{ env.ADDONS_DIR }}/

      - name: Restart Odoo container
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && docker compose restart odoo19"
