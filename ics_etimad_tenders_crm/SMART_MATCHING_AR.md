# نظام التطابق الذكي — دليل الاستخدام (عربي)

## نظرة عامة

نظام **التطابق الذكي** في تطبيق مناقصات اعتماد يوفّر تصنيفاً وتوجيهاً تلقائياً للمناقصات باستخدام **قواعد ديناميكية**. عند إنشاء مناقصة أو تحديثها، يتم تقييم القواعد النشطة بالترتيب؛ وكل قاعدة يمكن أن تعيّن مستخدماً، أو تضع المناقصة كـ «مفضلة»، أو تضيف ملاحظات/أسباب بناءً على شروط تحددها أنت.

يعمل التطابق الذكي إلى جانب **نسبة التطابق** (المحسوبة من الأنشطة والجهات والفئات المفضلة). القواعد الديناميكية تضيف **إجراءات قابلة للتخصيص** دون تغيير الكود.

---

## متى تُطبَّق القواعد

| المحفّز | الوصف |
|---------|--------|
| **مناقصة جديدة** | عند إنشاء مناقصة (مثلاً جلبها من اعتماد)، تُطبَّق كل القواعد النشطة. |
| **تحديث مناقصة** | عند حفظ أي مناقصة (كتابة)، تُعاد تطبيق القواعد. |
| **يدوياً** | من قائمة المناقصات: زر **تطبيق قواعد التطابق** في رأس القائمة، أو من نموذج المناقصة. |

تُطبَّق القواعد فقط إذا كان **التطابق الذكي** مفعّلاً من: **مناقصات اعتماد** → **الإعدادات** → **الإعدادات** → تبويب **التطابق الذكي**.

---

## أين يتم الإعداد

- **تفعيل/إلغاء التطابق الذكي:**  
  **مناقصات اعتماد** → **الإعدادات** → **الإعدادات** → تبويب **التطابق الذكي** → **تفعيل التطابق الذكي**.

- **إنشاء وتعديل القواعد:**  
  **مناقصات اعتماد** → **الإعدادات** → **قواعد التطابق الديناميكية**.  
  أو من الإعدادات → **إدارة القواعد الديناميكية**.

---

## هيكل القاعدة

كل قاعدة تحتوي على:

1. **الشرط** — *متى* تُطبَّق القاعدة (الحقل، المعامل، والقيمة).
2. **الإجراء** — *ماذا* يحدث عند تحقق الشرط (تعيين مستخدم، تعيين مفضلة، إضافة ملاحظة، إضافة سبب).

يتم تقييم القواعد حسب **الترتيب (Sequence)** (الأصغر أولاً). يمكن أن تتطابق عدة قواعد مع نفس المناقصة؛ يتم دمج إجراءاتها (مثلاً قاعدة تعيّن المستخدم وأخرى تضيف ملاحظة).

---

## الشرط: الحقول

يمكن بناء الشرط على الحقول التالية للمناقصة:

| الحقل | الوصف |
|-------|--------|
| **اسم المناقصة** | العنوان الكامل للمناقصة. |
| **اسم الجهة** | الجهة المصدرة (وزارة، هيئة، ...). |
| **اسم النشاط** | نشاط/مجال العمل. |
| **نوع المناقصة** | نوع اعتماد (توريد، خدمات، ...). |
| **الوصف** | نص وصف المناقصة. |
| **القيمة التقديرية** | القيمة المالية (رقم). |
| **الأيام المتبقية** | الأيام حتى انتهاء الموعد (رقم). |
| **تكلفة المستندات** | تكلفة وثائق المناقصة (رقم). |
| **مدة العقد (أيام)** | مدة العقد بالأيام (رقم). |
| **غرض المناقصة** | نص الغرض/النطاق. |
| **تفاصيل النشاط** | تفاصيل النشاط. |
| **مناطق التنفيذ** | المناطق التي يُنفَّذ فيها العمل. |
| **مدن التنفيذ** | المدن التي يُنفَّذ فيها العمل. |

---

## الشرط: المعاملات (Operators)

### حقول نصية (الاسم، الجهة، النشاط، الوصف، ...)

| المعامل | المعنى | مثال |
|---------|--------|------|
| **يحتوي** | الحقل يحتوي على النص (بدون مراعاة الحجم). | الجهة تحتوي "وزارة" |
| **لا يحتوي** | الحقل لا يحتوي على النص. | الاسم لا يحتوي "استشارات" |
| **يساوي** | تطابق تام (بدون مراعاة الحجم). | النشاط يساوي "خدمات تقنية" |
| **لا يساوي** | غير متطابق. | النوع لا يساوي "توريد" |
| **يبدأ بـ** | الحقل يبدأ بالنص. | الاسم يبدأ بـ "توريد" |
| **ينتهي بـ** | الحقل ينتهي بالنص. | الاسم ينتهي بـ "صيانة" |
| **تطابق نمطي (Regex)** | تعبير منتظم. | الاسم يطابق النمط المطلوب |
| **في القائمة** | قيمة الحقل إحدى القيم المفصولة بفاصلة. | القيمة: `IT, برمجيات, تقنية` |
| **فارغ** | الحقل فارغ أو غير معرّف. | لا حاجة لقيمة. |
| **غير فارغ** | للحقل أي قيمة. | لا حاجة لقيمة. |

### حقول رقمية (القيمة التقديرية، الأيام المتبقية، تكلفة المستندات، مدة العقد)

| المعامل | المعنى | مثال |
|---------|--------|------|
| **أكبر من** | الحقل > القيمة | القيمة التقديرية > 1,000,000 |
| **أكبر أو يساوي** | الحقل ≥ القيمة | الأيام المتبقية ≥ 14 |
| **أقل من** | الحقل < القيمة | تكلفة المستندات < 5000 |
| **أقل أو يساوي** | الحقل ≤ القيمة | الأيام المتبقية ≤ 7 |
| **يساوي** / **يحتوي** / **في القائمة** | استخدم **القيمة (نص)** أو **القيمة (رقم)**. | |

- لمعاملات **أكبر/أقل** استخدم **القيمة (رقم)** أو **القيمة (نص)** (مثلاً `1000000`).
- **فارغ** / **غير فارغ** تعمل على الحقول الرقمية (فارغ = صفر أو غير معرّف).

---

## الإجراءات

عند تحقق شرط القاعدة، يُطبَّق أحد الإجراءات التالية:

| الإجراء | الوصف | ما الذي تضبطه |
|---------|--------|----------------|
| **تعيين لمستخدم** | تعيين حقل **المعيّن إليه** في المناقصة. | **تعيين إلى:** اختيار المستخدم. |
| **وضع كمفضلة** | وضع المناقصة كـ **مفضلة**. | لا شيء إضافي. |
| **إلحاق بالملاحظات الداخلية** | إضافة نص إلى **الملاحظات الداخلية**. | **القيمة:** نص الملاحظة. |
| **إلحاق بأسباب التطابق** | إضافة نص إلى **أسباب التطابق الديناميكية** (تظهر مع أسباب التطابق المحسوبة). | **القيمة:** نص السبب. |

- **المعيّن إليه** و**أسباب التطابق الديناميكية** يظهران في نموذج المناقصة (منطقة تكامل CRM وفي القائمة/كانبان إن وُجد).
- إذا تطابقت عدة قواعد، تُدمج تأثيراتها (مثلاً واحدة تعيّن المستخدم وأخرى تضيف ملاحظة).

---

## خطوة بخطوة: إنشاء قاعدة

1. الانتقال إلى **مناقصات اعتماد** → **الإعدادات** → **قواعد التطابق الديناميكية**.
2. النقر على **جديد**.
3. **القاعدة**
   - **الاسم:** مثلاً "مناقصات تقنية ذات قيمة عالية".
   - **الترتيب:** رقم أصغر = يُطبَّق أولاً (مثلاً 10، 20).
   - **نشط:** مفعّل.
4. تبويب **الشرط**
   - **الحقل:** مثلاً **القيمة التقديرية**.
   - **المعامل:** مثلاً **أكبر من**.
   - **القيمة (رقم):** مثلاً `1000000`.
   - للنص: استخدم **القيمة (نص)** (مثلاً "وزارة"، "IT").
5. تبويب **الإجراء**
   - **الإجراء:** مثلاً **تعيين لمستخدم**.
   - **تعيين إلى:** اختيار المسؤول عن المبيعات.
6. حفظ.

ستُطبَّق القاعدة عند كل إنشاء/تحديث عندما يكون التطابق الذكي مفعّلاً، وعند النقر على **تطبيق قواعد التطابق**.

---

## أمثلة

### مثال 1: تعيين مناقصات ذات قيمة عالية لمسؤول مبيعات أول

- **الشرط:** الحقل = **القيمة التقديرية**، المعامل = **أكبر من**، القيمة (رقم) = `5000000`.
- **الإجراء:** **تعيين لمستخدم** → اختيار المستخدم.

### مثال 2: وضع المناقصات العاجلة كمفضلة

- **الشرط:** الحقل = **الأيام المتبقية**، المعامل = **أقل أو يساوي**، القيمة (رقم) = `7`.
- **الإجراء:** **وضع كمفضلة**.

### مثال 3: تمييز مناقصات جهة معينة

- **الشرط:** الحقل = **اسم الجهة**، المعامل = **يحتوي**، القيمة (نص) = `الرياض`.
- **الإجراء:** **إلحاق بأسباب التطابق**، القيمة = `جهة مفضلة (الرياض)`.

### مثال 4: ملاحظة للمناقصات المتعلقة بالتقنية

- **الشرط:** الحقل = **اسم النشاط**، المعامل = **يحتوي**، القيمة (نص) = `IT`.
- **الإجراء:** **إلحاق بالملاحظات الداخلية**، القيمة = `مراجعة فريق التقنية.`.

### مثال 5: قيم متعددة (في القائمة)

- **الشرط:** الحقل = **نوع المناقصة**، المعامل = **في القائمة**، القيمة (نص) = `Supply, توريد, Services`.
- **الإجراء:** **وضع كمفضلة** أو **تعيين لمستخدم**.

---

## التشغيل اليدوي: تطبيق قواعد التطابق

- **من القائمة:** تحديد مناقصة أو أكثر → النقر على **تطبيق قواعد التطابق** في رأس القائمة.
- **من النموذج:** فتح المناقصة → النقر على **تطبيق قواعد التطابق** في شريط الإجراءات.

هذا يعيد تقييم كل القواعد النشطة للمناقصة/المناقصات المحددة ويحدّث **المعيّن إليه**، **مفضلة**، **الملاحظات الداخلية**، و**أسباب التطابق الديناميكية**.

---

## نصائح

- استخدم **الترتيب** للتحكم في أولوية القواعد (مثلاً قواعد عامة أولاً ثم الخاصة).
- يمكن تعطيل قاعدة بإلغاء **نشط** بدلاً من حذفها.
- **التطابق النمطي (Regex)** مفيد لأنماط معقدة (كلمات متعددة). اختبر القيم لتجنب الأخطاء.
- قيم **في القائمة** مفصولة بفاصلة؛ المسافات بعد الفاصلة مسموحة.
- المقارنات الرقمية تستخدم **القيمة (رقم)** أو **القيمة (نص)**؛ للمبالغ يمكن استخدام `1000000` أو `1,000,000` حسب الدعم.

---

## ملخص

| البند | الموقع / الإجراء |
|-------|-------------------|
| تفعيل التطابق الذكي | الإعدادات → التطابق الذكي |
| إنشاء/تعديل القواعد | الإعدادات → قواعد التطابق الديناميكية |
| متى تُطبَّق القواعد | عند إنشاء/تحديث المناقصة أو «تطبيق قواعد التطابق» |
| الشرط | حقل واحد + معامل + قيمة/قيم |
| الإجراءات | تعيين مستخدم، وضع مفضلة، إلحاق ملاحظة، إلحاق سبب تطابق |

للتفاصيل التقنية (النماذج، الحقول، الدوال) راجع كود الوحدة في `ics_etimad_tenders_crm` (مثلاً `models/etimad_matching_rule.py`, `models/etimad_tender.py`).
